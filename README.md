# Coding Evaluation

## Background
Our customers are sending billions of requests each day that need to be
processed. Today, all incoming requests are processed regardless of
their validity, leading to slower processing. We want to filter out
invalid requests (badly formatted, containing invalid values, missing
required fields, â€¦) but keep a history on a day-by-day basis so that
we can properly charge customers for the traffic they send.

## Task
You must write an HTTP service that 
Task 1:  receive requests generated by our collector
My Approach :
 I have implemented POST operation to process the request
  CustomerRequestController : http://localhost:8085/customer/request
  providing customer request as json body
  {"customerID":1,
  	"tagID":2,
  	"userID":"aaaaaaaa-bbbb-cccc-1111-222222222222",
  	"remoteIP":"123.234.56.78",
  	"timestamp":1500000000}
  	
Task 2:  check the validity of each request
         reject invalid requests
My Approach :
  I have implemented RequestValidationHandler and below user defined exceptions to filter the request and handle all exceptions
  
Task 3:
- count and store statistics per customer per hour
Your code should contain a stub function to which you should pass all valid requests.

My Approach :
  To implement above criteria, we need to perform below tasks for each request
   - check the validity of each request
   - check for customerId, black listed remote IP and User agent
   - check the hourly_stats for existing records for last one hour, then if it exists we need to get the record
     update request_count or invalid request
 Considering the facts that Our customers will send billions of requests each day and slower processing system,
 I came up with below solution,
 
  Instead of storing requests in hourly_stats table, 
  We can store each request in request_data after checking the validity
  src\main\resources\db_mysql.sql - file has all the db scripts
  
  `request_data`
  ( `request_id` int(11)  NOT NULL AUTO_INCREMENT,
     `request_payload` varchar(1000) not null ,
    `customer_id`  int(11) not null ,
    `request_time` timestamp not null ,
     `status` char(1) not null default 'Y',
   constraint `request_data_pk` primary key(`request_id`));
 Task 4:
  The service must also provide
  - an endpoint to get the statistics
    - for a specific customer 
    AND
    - a specific day
  The response must also contain the total number of requests for that day.
  
  I have provided the Rest GET operation to get the customer requests count for a specific date
  http://localhost:8085/customer/statistics?id=2&requestDate=2020.07.27
  
  With below query we can get the requests count
   @Query(value ="select count(request_id) from request_data where customer_id = ?1 and date(request_time) = ?2", nativeQuery = true)
   long findAllWithCustomerIdAndRequestTime(Integer customer_id, LocalDate request_time);
   
 With this approach, 
  - Request processing will be fast
  - We can have customer request's history with payload
  - We can check which customer sends which types of requests
  - We can get the valid/invalid request count per day, per week and per month
  - Even we can have request count with a date range
 
 This approach has below disadvantage :
   We are going to store huge data into our database, as we are storing each request,
   but we can have a scheduler job to delete older data  

### Requests considered as invalid are:
* malformed JSON
* missing one or more fields
RequestValidationHandler will handle the above exceptions

* missing customer id or more fields
* with a customer ID not found in the database or for a customer which is disabled
   Application will throw CustomerNotFoundException andCustomerNotActiveException

* with a remote IP address which is in the blacklist
  Application will throw BlackListedIPException
  
* with a user agent which is in the blacklist
 Application will throw BlackListedUserAgentException

### The stats table will contain:
* one entry per hour and per customer ID

* the `request_count` column contains the number of valid requests
`request_data` table have the 'status' column
 if its 'Y' - valid request

* the `invalid_count` column will be used for the number of invalid requests
if its 'N' - invalid request

Tools and technologies
------------------------
IntelliJ IDEA 2020.1.4
Java 11
Spring Boot 2.3.1
Spring Data JPA
MySQL DB :jdbc:mysql://localhost:3306/adex_db

WebMvcTest for Unit Testing
slf4j for logging